# Kubernetes Deployment for TaskManager
# VULN: Multiple misconfigurations for Checkov testing
apiVersion: apps/v1
kind: Deployment
metadata:
  name: taskmanager
  namespace: default
  labels:
    app: taskmanager
spec:
  replicas: 3
  selector:
    matchLabels:
      app: taskmanager
  template:
    metadata:
      labels:
        app: taskmanager
    spec:
      # VULN: No specific serviceAccountName (CKV_K8S_41)
      
      containers:
      - name: taskmanager
        image: taskmanager:latest
        # VULN: Tag 'latest' is not reproducible (CKV_K8S_14)
        
        ports:
        - containerPort: 5000
          protocol: TCP
        
        # VULN: No resources defined (CKV_K8S_11, CKV_K8S_12, CKV_K8S_13)
        # Should have:
        # resources:
        #   limits:
        #     cpu: "500m"
        #     memory: "128Mi"
        #   requests:
        #     cpu: "250m"
        #     memory: "64Mi"
        
        securityContext:
          # VULN: Privileged container (CKV_K8S_1)
          privileged: true  # VULN: Should be false
          
          # VULN: Runs as root (CKV_K8S_6)
          runAsUser: 0  # VULN: Should not be 0 (root)
          runAsNonRoot: false  # VULN: Should be true
          
          # VULN: Allows privilege escalation (CKV_K8S_20)
          allowPrivilegeEscalation: true  # VULN: Should be false
          
          # VULN: Writable filesystem (CKV_K8S_22)
          readOnlyRootFilesystem: false  # VULN: Should be true
          
          # VULN: Dangerous capabilities (CKV_K8S_25)
          capabilities:
            add:
              - NET_ADMIN
              - SYS_ADMIN  # VULN: Very dangerous
              - SYS_PTRACE
        
        env:
        # VULN: Secrets in plain environment variables (CKV_K8S_35)
        - name: DATABASE_PASSWORD
          value: "APR6L2qvsO0enQleMu9g7ur17Pa2zkRB0iU5BAzgjDE="  # VULN: Should use secretRef
        - name: API_KEY
          value: "sk_live_xxxxxxxxxxxx"  # VULN: Hardcoded secret
        - name: JWT_SECRET
          value: "ys47UNkD7JOLr7CiBXVVpddopaMny0okmPBgyrHnAPo="
        
        # Sin health checks (CKV_K8S_8, CKV_K8S_9)
        # livenessProbe: ...
        # readinessProbe: ...
        
        volumeMounts:
        - name: data
          mountPath: /app/data
        # VULN: Docker socket mount (CKV_K8S_27)
        - name: docker-sock
          mountPath: /var/run/docker.sock
      
      volumes:
      - name: data
        hostPath:
          path: /data/taskmanager
          # VULN: hostPath (CKV_K8S_26)
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock
          # VULN: Docker socket mounted (CKV_K8S_27)
      
      # VULN: No network policy (CKV_K8S_4)
      # VULN: No pod security policy
      
      hostNetwork: true  # VULN: Host network (CKV_K8S_19)
      hostPID: true      # VULN: Host PID namespace (CKV_K8S_17)
---
apiVersion: v1
kind: Service
metadata:
  name: taskmanager-service
  namespace: default
spec:
  type: LoadBalancer  # Exposed externally
  selector:
    app: taskmanager
  ports:
  - port: 80
    targetPort: 5000
    protocol: TCP
