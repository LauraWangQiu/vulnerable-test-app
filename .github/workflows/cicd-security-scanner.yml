# CI/CD Security Pipeline â€” all scanner modules
#
# Triggers:
#   workflow_dispatch  â†’ manual, full-repo scans (select scanners & tools)
#   pull_request       â†’ automatic PR-scoped scans on all scanners
#
# Tool defaults:
#   secrets: gitleaks | trufflehog      sast: semgrep | bandit
#   sca:     trivy    | grype           iac:  checkov | trivy
#   containers: trivy | grype
#
# Override tool per PR with labels:  scan:<scanner>=<tool>
#   e.g.  scan:sast=bandit   scan:containers=grype
name: Security Pipeline

on:
  workflow_dispatch:
    inputs:
      scan_secrets:
        description: 'Run Secrets scan'
        required: false
        default: true
        type: boolean
      secrets_tool:
        description: 'Secret scanner tool'
        required: false
        default: 'gitleaks'
        type: choice
        options: [gitleaks, trufflehog]
      secrets_mode:
        description: 'Secret scan mode'
        required: false
        default: 'all'
        type: choice
        options: [all, files, history]
      scan_sast:
        description: 'Run SAST scan'
        required: false
        default: true
        type: boolean
      sast_tool:
        description: 'SAST scanner tool'
        required: false
        default: 'semgrep'
        type: choice
        options: [semgrep, bandit]
      scan_sca:
        description: 'Run SCA scan'
        required: false
        default: true
        type: boolean
      sca_tool:
        description: 'SCA scanner tool'
        required: false
        default: 'trivy'
        type: choice
        options: [trivy, grype]
      scan_iac:
        description: 'Run IaC scan'
        required: false
        default: true
        type: boolean
      iac_tool:
        description: 'IaC scanner tool'
        required: false
        default: 'checkov'
        type: choice
        options: [checkov, trivy]
      scan_containers:
        description: 'Run Container scan'
        required: false
        default: true
        type: boolean
      containers_tool:
        description: 'Container scanner tool'
        required: false
        default: 'trivy'
        type: choice
        options: [trivy, grype]

  pull_request:
    branches: [master]

permissions:
  contents: read
  security-events: write
  pull-requests: write

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
jobs:

  # â”€â”€ Read all scan:<scanner>=<tool> labels once â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  detect-overrides:
    name: ğŸ·ï¸ Detect PR Label Overrides
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    outputs:
      secrets:    ${{ steps.labels.outputs.secrets }}
      sast:       ${{ steps.labels.outputs.sast }}
      sca:        ${{ steps.labels.outputs.sca }}
      iac:        ${{ steps.labels.outputs.iac }}
      containers: ${{ steps.labels.outputs.containers }}
    steps:
      - id: labels
        uses: actions/github-script@v7
        with:
          script: |
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });
            for (const scanner of ['secrets', 'sast', 'sca', 'iac', 'containers']) {
              const match = labels.find(l => new RegExp(`^scan:${scanner}=(.+)$`, 'i').test(l.name));
              core.setOutput(scanner, match ? match.name.split('=')[1].trim() : '');
            }

  # â”€â”€ Secrets (workflow_dispatch only: files) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secrets-full-scan-files:
    name: ğŸ” Secrets â€“ Full Repo (files)
    if: >-
      github.event_name == 'workflow_dispatch' &&
      inputs.scan_secrets == true &&
      (inputs.secrets_mode == 'all' || inputs.secrets_mode == 'files')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          tool: ${{ inputs.secrets_tool }}
          scan_mode: 'files'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  # â”€â”€ Secrets (workflow_dispatch only: history) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secrets-full-scan-history:
    name: ğŸ” Secrets â€“ Full Repo (history)
    if: >-
      github.event_name == 'workflow_dispatch' &&
      inputs.scan_secrets == true &&
      (inputs.secrets_mode == 'all' || inputs.secrets_mode == 'history')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          tool: ${{ inputs.secrets_tool }}
          scan_mode: 'history'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  # â”€â”€ Secrets (PR only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  secrets-pr-scan:
    name: ğŸ” Secrets â€“ PR Diff
    if: github.event_name == 'pull_request'
    needs: [detect-overrides]
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          tool: ${{ needs.detect-overrides.outputs.secrets }}
          scan_mode: 'pr'
          base_ref: ${{ github.base_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

  # â”€â”€ SAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sast-scan:
    name: ğŸ” SAST â€“ Static Code Analysis
    needs: [detect-overrides]
    if: >-
      !failure() &&
      ((github.event_name == 'workflow_dispatch' && inputs.scan_sast == true) ||
       github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/sast@main
        with:
          tool: ${{ needs.detect-overrides.outputs.sast || inputs.sast_tool }}
          config: 'auto'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_findings: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ SCA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sca-scan:
    name: ğŸ“¦ SCA â€“ Dependency Scan
    needs: [detect-overrides]
    if: >-
      !failure() &&
      ((github.event_name == 'workflow_dispatch' && inputs.scan_sca == true) ||
       github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/sca@main
        with:
          tool: ${{ needs.detect-overrides.outputs.sca || inputs.sca_tool }}
          severity: 'HIGH,CRITICAL'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_vulnerabilities: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ IaC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  iac-scan:
    name: ğŸ—ï¸ IaC â€“ Infrastructure as Code
    needs: [detect-overrides]
    if: >-
      !failure() &&
      ((github.event_name == 'workflow_dispatch' && inputs.scan_iac == true) ||
       github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/iac@main
        with:
          tool: ${{ needs.detect-overrides.outputs.iac || inputs.iac_tool }}
          framework: 'all'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_findings: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ Containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  container-scan:
    name: ğŸ³ Container â€“ Image Scan
    needs: [detect-overrides]
    if: >-
      !failure() &&
      ((github.event_name == 'workflow_dispatch' && inputs.scan_containers == true) ||
       github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/containers@main
        with:
          tool: ${{ needs.detect-overrides.outputs.containers || inputs.containers_tool }}
          severity: 'HIGH,CRITICAL'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_vulnerabilities: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€ Security Gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-gate:
    name: ğŸš¦ Security Gate
    if: always()
    needs:
      - secrets-full-scan-files
      - secrets-full-scan-history
      - secrets-pr-scan
      - sast-scan
      - sca-scan
      - iac-scan
      - container-scan
    runs-on: ubuntu-latest
    steps:
      - name: Check all scans passed
        run: |
          FAILED=false
          for result in \
            "${{ needs.secrets-full-scan-files.result }}" \
            "${{ needs.secrets-full-scan-history.result }}" \
            "${{ needs.secrets-pr-scan.result }}" \
            "${{ needs.sca-scan.result }}" \
            "${{ needs.sast-scan.result }}" \
            "${{ needs.iac-scan.result }}" \
            "${{ needs.container-scan.result }}"; do
            if [ "$result" == "failure" ]; then FAILED=true; fi
          done
          if [ "$FAILED" == "true" ]; then
            echo "âŒ Security gate failed â€” fix vulnerabilities before merging"
            exit 1
          fi
          echo "âœ… All security checks passed"
