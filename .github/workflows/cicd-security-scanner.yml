# Example workflow using all CICD Security Scanner modules
#
# Two trigger modes:
#   1. workflow_dispatch (manual): Run any combination of scanners on the full repository
#   2. pull_request (automatic):   PR-scoped scans â€” all scanners run only on changed files
#
# Each scanner supports a "tool" input to select the underlying engine:
#   - secrets:    gitleaks (default), trufflehog
#   - sast:       semgrep (default), bandit
#   - sca:        trivy (default), grype
#   - iac:        checkov (default), trivy
#   - containers: trivy (default), grype
name: Security Pipeline

on:
  # Manual trigger â€” select which scanners and tools to run
  workflow_dispatch:
    inputs:
      scan_secrets:
        description: 'Run Secrets scan'
        required: false
        default: true
        type: boolean
      secrets_tool:
        description: 'Secret scanner tool'
        required: false
        default: 'gitleaks'
        type: choice
        options:
          - gitleaks
          - trufflehog
      secrets_mode:
        description: 'Secret scan mode (only if scan_secrets is true)'
        required: false
        default: 'all'
        type: choice
        options:
          - all       # Both files and history
          - files     # Current files only
          - history   # Git commit history only
      scan_sast:
        description: 'Run SAST scan'
        required: false
        default: true
        type: boolean
      sast_tool:
        description: 'SAST scanner tool'
        required: false
        default: 'semgrep'
        type: choice
        options:
          - semgrep
          - bandit
      scan_sca:
        description: 'Run SCA scan'
        required: false
        default: true
        type: boolean
      sca_tool:
        description: 'SCA scanner tool'
        required: false
        default: 'trivy'
        type: choice
        options:
          - trivy
          - grype
      scan_iac:
        description: 'Run IaC scan'
        required: false
        default: true
        type: boolean
      iac_tool:
        description: 'IaC scanner tool'
        required: false
        default: 'checkov'
        type: choice
        options:
          - checkov
          - trivy
      scan_containers:
        description: 'Run Container scan'
        required: false
        default: true
        type: boolean
      containers_tool:
        description: 'Container scanner tool'
        required: false
        default: 'trivy'
        type: choice
        options:
          - trivy
          - grype

  # Automatic on PRs to master
  pull_request:
    branches: [master]

permissions:
  contents: read
  security-events: write
  pull-requests: write

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  MANUAL / PR: Secrets
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  secrets-full-scan-files:
    name: ğŸ” Secrets â€“ Full Repo (files)
    if: >-
      github.event_name == 'workflow_dispatch' &&
      inputs.scan_secrets == true &&
      (inputs.secrets_mode == 'all' || inputs.secrets_mode == 'files')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          tool: ${{ inputs.secrets_tool }}
          scan_mode: 'files'

  secrets-full-scan-history:
    name: ğŸ” Secrets â€“ Full Repo (history)
    if: >-
      github.event_name == 'workflow_dispatch' &&
      inputs.scan_secrets == true &&
      (inputs.secrets_mode == 'all' || inputs.secrets_mode == 'history')
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          tool: ${{ inputs.secrets_tool }}
          scan_mode: 'history'

  secrets-pr-scan:
    name: ğŸ” Secrets â€“ PR Diff
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/secrets@main
        with:
          scan_mode: 'pr'
          base_ref: ${{ github.base_ref }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  MANUAL / PR: SAST
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sast-scan:
    name: ğŸ” SAST â€“ Static Code Analysis
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.scan_sast == true) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/sast@main
        with:
          tool: ${{ inputs.sast_tool }}
          config: 'auto'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_findings: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  MANUAL / PR: SCA
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  sca-scan:
    name: ğŸ“¦ SCA â€“ Dependency Scan
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.scan_sca == true) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/sca@main
        with:
          tool: ${{ inputs.sca_tool }}
          severity: 'HIGH,CRITICAL'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_vulnerabilities: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  MANUAL / PR: IaC
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  iac-scan:
    name: ğŸ—ï¸ IaC â€“ Infrastructure as Code
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.scan_iac == true) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/iac@main
        with:
          tool: ${{ inputs.iac_tool }}
          framework: 'all'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_findings: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  MANUAL / PR: Container
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  container-scan:
    name: ğŸ³ Container â€“ Dockerfile Scan
    if: >-
      (github.event_name == 'workflow_dispatch' && inputs.scan_containers == true) ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: LauraWangQiu/cicd-security-scanner/containers@main
        with:
          tool: ${{ inputs.containers_tool }}
          severity: 'HIGH,CRITICAL'
          scan_mode: ${{ github.event_name == 'pull_request' && 'pr' || 'full' }}
          base_ref: ${{ github.base_ref }}
          fail_on_vulnerabilities: 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  #  Security Gate â€” all selected scans must pass
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  security-gate:
    name: ğŸš¦ Security Gate
    if: always()
    needs: [secrets-full-scan-files, secrets-full-scan-history, secrets-pr-scan, sca-scan, sast-scan, iac-scan, container-scan]
    runs-on: ubuntu-latest
    steps:
      - name: Check all scans passed
        run: |
          FAILED=false
          for result in \
            "${{ needs.secrets-full-scan-files.result }}" \
            "${{ needs.secrets-full-scan-history.result }}" \
            "${{ needs.secrets-pr-scan.result }}" \
            "${{ needs.sca-scan.result }}" \
            "${{ needs.sast-scan.result }}" \
            "${{ needs.iac-scan.result }}" \
            "${{ needs.container-scan.result }}"; do
            # Only count "failure" â€” skip "skipped" jobs (not selected or not triggered)
            if [ "$result" == "failure" ]; then FAILED=true; fi
          done
          if [ "$FAILED" == "true" ]; then
            echo "âŒ Security gate failed â€” fix vulnerabilities before merging"
            exit 1
          fi
          echo "âœ… All security checks passed"
